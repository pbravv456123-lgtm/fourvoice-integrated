{% extends "base.html" %}

{% block content %}
<style>
    .modal-header-custom { background-color: #f0f7ff; border-bottom: 1px solid #e1e8f0; padding: 1.5rem; }
    .modal-title-custom { font-weight: 700; color: #1a2b4b; font-size: 1.5rem; margin-bottom: 0; }
    .modal-subtitle { color: #64748b; font-size: 0.9rem; margin-top: 0.25rem; }
    .form-label-custom { font-weight: 600; font-size: 0.85rem; color: #334155; margin-bottom: 0.5rem; }
    .form-control-custom, .form-select-custom { padding: 0.75rem; border-radius: 8px; border: 1px solid #cbd5e1; }
    .btn-update { background-color: #1d4ed8; color: white; padding: 0.6rem 1.5rem; border-radius: 8px; font-weight: 600; }
    .btn-cancel { color: #64748b; text-decoration: none; font-weight: 600; margin-right: 1.5rem; }
    
    /* Category Row & Badge Styling */
    .text-orange { color: #f97316 !important; } 
    .text-purple { color: #a855f7 !important; }
    .category-row { background-color: #f8fafc; border-top: 1px solid #e2e8f0; }
    
    .badge-services { background-color: #e0f2fe; color: #0369a1; }
    .badge-consulting { background-color: #ffedd5; color: #c2410c; }
    .badge-packages { background-color: #dcfce7; color: #15803d; }
    .badge-products { background-color: #f3e8ff; color: #7e22ce; }

    /* NEW: Sorting Styles */
    .sortable-header { 
        cursor: pointer; 
        transition: background-color 0.2s;
        user-select: none;
    }
    .sortable-header:hover { background-color: #e2e8f0; }
    .sort-icon { font-size: 0.8em; margin-left: 5px; color: #94a3b8; }
</style>

<div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h2 class="fw-bold mb-0">Product & Service Catalogue</h2>
        <p class="text-muted small mb-0" id="item-count">{{ products|length }} items in catalogue</p>
    </div>
    <button class="btn btn-primary rounded-pill px-4 shadow-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">
        <i class="bi bi-plus-lg me-2"></i>Add Product/Service
    </button>
</div>

<div class="card mb-4 border-0 shadow-sm rounded-3">
    <div class="card-body p-4">
        <div class="row g-3">
            <div class="col-md-8">
                <div class="input-group border rounded-3 overflow-hidden">
                    <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="catalogueSearch" class="form-control border-0 shadow-none" placeholder="Search by name, description, or SKU...">
                </div>
            </div>
            <div class="col-md-4">
                <select class="form-select border rounded-3 shadow-none" id="categoryFilter">
                    <option value="all">All Categories</option>
                    <option value="Services">Services</option>
                    <option value="Consulting">Consulting</option>
                    <option value="Packages">Packages</option>
                    <option value="Products">Products</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm rounded-4 overflow-hidden">
    <div class="table-responsive">
        <table class="table align-middle mb-0">
            <thead class="bg-light">
                <tr class="text-muted small text-uppercase">
                    <th class="ps-4 sortable-header" onclick="sortCatalogue('sku')">
                        SKU <i class="bi bi-arrow-down-up sort-icon" id="icon-sku"></i>
                    </th>
                    <th class="sortable-header" onclick="sortCatalogue('name')">
                        Product/Service <i class="bi bi-arrow-down-up sort-icon" id="icon-name"></i>
                    </th>
                    <th class="sortable-header" onclick="sortCatalogue('desc')">
                        Description <i class="bi bi-arrow-down-up sort-icon" id="icon-desc"></i>
                    </th>
                    <th>Category</th>
                    <th class="sortable-header" onclick="sortCatalogue('price')">
                        Price <i class="bi bi-arrow-down-up sort-icon" id="icon-price"></i>
                    </th>
                    <th class="text-end pe-4">Actions</th>
                </tr>
            </thead>
            <tbody id="catalogueBody">
                {% set grouped = {} %}
                {% for p in products %}
                    {% if p.category not in grouped %}{% set _ = grouped.update({p.category: []}) %}{% endif %}
                    {% set _ = grouped[p.category].append(p) %}
                {% endfor %}

                {% for cat, items in grouped.items() %}
                <tr class="category-row">
                    <td colspan="6" class="ps-4 py-2">
                        <div class="d-flex align-items-center gap-2">
                            {% if cat == 'Services' %}<i class="bi bi-wrench text-primary"></i>
                            {% elif cat == 'Consulting' %}<i class="bi bi-briefcase text-orange"></i>
                            {% elif cat == 'Packages' %}<i class="bi bi-box-seam text-success"></i>
                            {% else %}<i class="bi bi-box text-purple"></i>{% endif %}
                            <span class="fw-bold text-dark small text-uppercase">{{ cat }} <span class="text-muted fw-normal">({{ items|length }} items)</span></span>
                        </div>
                    </td>
                </tr>
                {% for p in items %}
                <tr class="item-row" 
                    data-sort-sku="{{ p.sku|lower }}" 
                    data-sort-name="{{ p.name|lower }}" 
                    data-sort-desc="{{ p.description|lower }}" 
                    data-sort-price="{{ p.price }}">
                    
                    <td class="ps-4 small text-muted">{{ p.sku }}</td>
                    <td class="fw-bold">{{ p.name }}</td>
                    <td class="text-muted small">{{ p.description }}</td>
                    <td>
                        <span class="badge rounded-pill 
                            {% if p.category == 'Services' %}badge-services
                            {% elif p.category == 'Consulting' %}badge-consulting
                            {% elif p.category == 'Packages' %}badge-packages
                            {% elif p.category == 'Products' %}badge-products
                            {% endif %}">{{ p.category }}</span>
                    </td>
                    <td class="fw-bold">S${{ "%.2f"|format(p.price) }}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-link text-muted edit-btn" 
                                data-id="{{ p.id }}" data-sku="{{ p.sku }}" data-name="{{ p.name }}" 
                                data-desc="{{ p.description }}" data-cat="{{ p.category }}" data-price="{{ p.price }}">
                            <i class="bi bi-pencil-square"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-danger delete-btn" 
                                data-id="{{ p.id }}" data-name="{{ p.name }}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="deleteProductModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg text-center">
            <div class="modal-body p-4">
                <div class="text-danger mb-3">
                    <i class="bi bi-exclamation-octagon-fill fs-1"></i>
                </div>
                <h4 class="fw-bold">Are you sure?</h4>
                <p class="text-muted small">You are about to delete <br><strong id="delete-item-name" class="text-dark"></strong></p>
                <div class="d-grid gap-2 mt-4">
                    <form id="deleteForm" method="POST">
                        <button type="submit" class="btn btn-danger w-100 rounded-pill mb-2">Delete Item</button>
                    </form>
                    <button type="button" class="btn btn-light w-100 rounded-pill" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form action="/catalogue/add" method="POST" class="modal-content border-0 shadow-lg">
            <div class="modal-header-custom position-relative">
                <h2 class="modal-title-custom">Add New Product/Service</h2>
                <p class="modal-subtitle">Enter the details below</p>
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label-custom">Product/Service Name *</label>
                        <input type="text" name="name" class="form-control form-control-custom" placeholder="e.g., Web Development" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">SKU *</label>
                        <input type="text" name="sku" class="form-control form-control-custom" placeholder="e.g., WEB-001" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label-custom">Description</label>
                        <textarea name="description" rows="3" class="form-control form-control-custom" placeholder="Brief description of the product or service"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">Category</label>
                        <select name="category" class="form-select form-select-custom">
                            <option value="Services">Services</option>
                            <option value="Packages">Packages</option>
                            <option value="Products">Products</option>
                            <option value="Consulting">Consulting</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">Price (S$) *</label>
                        <input type="number" step="0.01" name="price" class="form-control form-control-custom" placeholder="0.00" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <a href="#" class="btn-cancel" data-bs-dismiss="modal">Cancel</a>
                <button type="submit" class="btn btn-update px-4">Add Product</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form action="/catalogue/edit" method="POST" class="modal-content border-0 shadow-lg">
            <input type="hidden" name="id" id="edit-id">
            <div class="modal-header-custom position-relative">
                <h2 class="modal-title-custom">Edit Product/Service</h2>
                <p class="modal-subtitle">Enter the details below</p>
                <button type="button" class="btn-close position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-6">
                        <label class="form-label-custom">Product/Service Name *</label>
                        <input type="text" name="name" id="edit-name" class="form-control form-control-custom" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">SKU *</label>
                        <input type="text" name="sku" id="edit-sku" class="form-control form-control-custom" required>
                    </div>
                    <div class="col-12">
                        <label class="form-label-custom">Description</label>
                        <textarea name="description" id="edit-desc" rows="3" class="form-control form-control-custom"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">Category</label>
                        <select name="category" id="edit-cat" class="form-select form-select-custom">
                            <option value="Services">Services</option>
                            <option value="Packages">Packages</option>
                            <option value="Products">Products</option>
                            <option value="Consulting">Consulting</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-custom">Price (S$) *</label>
                        <input type="number" step="0.01" name="price" id="edit-price" class="form-control form-control-custom" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <a href="#" class="btn-cancel" data-bs-dismiss="modal">Cancel</a>
                <button type="submit" class="btn btn-update">Update Product</button>
            </div>
        </form>
    </div>
</div>

<script>
// --- NEW SORTING LOGIC START ---
let currentSort = { column: null, dir: 'asc' };

function sortCatalogue(column) {
    const tbody = document.getElementById('catalogueBody');
    const rows = Array.from(tbody.querySelectorAll('.item-row'));
    const catRows = document.querySelectorAll('.category-row');

    // Toggle direction
    if (currentSort.column === column) {
        currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.dir = 'asc';
    }

    // Sort the rows
    rows.sort((a, b) => {
        let valA = a.getAttribute(`data-sort-${column}`);
        let valB = b.getAttribute(`data-sort-${column}`);

        // Handle Price (Numbers) vs Text
        if (column === 'price') {
            return currentSort.dir === 'asc' ? valA - valB : valB - valA;
        } else {
            return currentSort.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        }
    });

    // Hide category headers when sorting, show when not
    // (Note: To simplify, once sorted, we just hide categories. 
    // To restore categories, user would refresh or we'd need complex logic to re-group)
    catRows.forEach(row => row.style.display = 'none'); 
    
    // Clear and Append sorted rows
    // We leave category rows in DOM but hidden, rearranging items below them
    rows.forEach(row => tbody.appendChild(row));

    // Update Icons
    document.querySelectorAll('.sort-icon').forEach(i => i.className = 'bi bi-arrow-down-up sort-icon');
    const activeIcon = document.getElementById(`icon-${column}`);
    activeIcon.className = `bi bi-sort-${column === 'price' ? 'numeric' : 'alpha'}-${currentSort.dir === 'asc' ? 'down' : 'up'} sort-icon text-dark`;
}
// --- NEW SORTING LOGIC END ---


function bindActionListeners() {
    // Edit Listeners
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('edit-id').value = this.dataset.id;
            document.getElementById('edit-name').value = this.dataset.name;
            document.getElementById('edit-sku').value = this.dataset.sku;
            document.getElementById('edit-desc').value = this.dataset.desc;
            document.getElementById('edit-cat').value = this.dataset.cat;
            document.getElementById('edit-price').value = this.dataset.price;
            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        };
    });

    // Delete Listeners
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = function() {
            document.getElementById('delete-item-name').innerText = this.dataset.name;
            document.getElementById('deleteForm').action = '/catalogue/delete/' + this.dataset.id;
            new bootstrap.Modal(document.getElementById('deleteProductModal')).show();
        };
    });
}

// Initial Bind
bindActionListeners();

// Category Filter Logic
document.getElementById('categoryFilter').addEventListener('change', function() {
    const selected = this.value;
    const rows = document.querySelectorAll('#catalogueBody tr');
    rows.forEach(row => {
        if (row.classList.contains('category-row')) {
            row.style.display = (selected === 'all' || row.innerText.includes(selected.toUpperCase())) ? '' : 'none';
        } else {
            const badge = row.querySelector('.badge');
            if(badge) {
                const cat = badge.innerText;
                row.style.display = (selected === 'all' || cat === selected) ? '' : 'none';
            }
        }
    });
});

// Fuzzy Search Logic
document.getElementById('catalogueSearch').addEventListener('input', function(e) {
    const query = e.target.value;
    fetch(`/search_catalogue?query=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            const body = document.getElementById('catalogueBody');
            body.innerHTML = ''; 
            data.results.forEach(p => {
                let badgeClass = `badge-${p.category.toLowerCase()}`;
                
                // Note: Added data-sort attributes here so sorting works after search
                body.innerHTML += `
                    <tr class="item-row" 
                        data-sort-sku="${p.sku.toLowerCase()}" 
                        data-sort-name="${p.name.toLowerCase()}" 
                        data-sort-desc="${(p.description || '').toLowerCase()}" 
                        data-sort-price="${p.price}">
                        
                        <td class="ps-4 small text-muted">${p.sku}</td>
                        <td class="fw-bold">${p.name}</td>
                        <td class="text-muted small">${p.description || ''}</td>
                        <td><span class="badge rounded-pill ${badgeClass}">${p.category}</span></td>
                        <td class="fw-bold">S$${parseFloat(p.price).toFixed(2)}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-sm btn-link text-muted edit-btn" 
                                data-id="${p.id}" data-sku="${p.sku}" data-name="${p.name}" 
                                data-desc="${p.description}" data-cat="${p.category}" data-price="${p.price}">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-danger delete-btn" 
                                data-id="${p.id}" data-name="${p.name}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
            bindActionListeners(); 
            document.getElementById('item-count').innerText = `${data.results.length} items found`;
        });
});
</script>
{% endblock %}