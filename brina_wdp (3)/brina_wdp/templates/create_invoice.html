{% extends "base.html" %}
{% block page_title %}<span class="ci-h1">Create New Invoice</span>{% endblock %}
{% block page_subtitle %}<span class="ci-h2">Fill in the details below to generate your invoice</span>{% endblock %}

{% block content %}
<div class="ci-page">

  <!-- Select Client -->
  <section class="ci-card">
    <div class="ci-card-head">
      <div>
        <div class="ci-label">Select Client <span class="req">*</span></div>
      </div>
    </div>

    <!-- Empty state (grey → blue on hover/click) -->
    <button type="button" class="ci-dashed-select" id="openClientPicker" aria-haspopup="dialog">
      <span id="ciClientSelectText">Click to select client</span>
    </button>

    <!-- Filled state (rendered by JS) -->
    <div class="ci-client-picked" id="ciClientPicked" hidden></div>
    <div class="ci-error" id="clientErr"></div>

    <!-- keep legacy badge for JS, but hidden -->
    <div id="selectedClientBadge" hidden></div>

    <!-- one-off name storage (used by JS + validation) -->
    <input type="hidden" id="oneoffName" value="">
  </section>

  <!-- Invoice Meta -->
  <section class="ci-card">
    <div class="ci-grid-2">
      <div class="ci-field">
        <label class="ci-label" for="invoiceNumber">Invoice Number <span class="req">*</span></label>
        <input class="ci-input" id="invoiceNumber" type="text" placeholder="INV-2026-432">
        <div class="ci-error" id="invoiceNumberErr"></div>
      </div>

      <div class="ci-field">
        <label class="ci-label" for="currency">Currency</label>
        <select class="ci-input ci-select" id="currency">
          <option value="SGD">sg Singapore Dollar (S$)</option>
          <option value="USD">us US Dollar ($)</option>
          <option value="EUR">eu Euro (€)</option>
          <option value="GBP">gb British Pound (£)</option>
          <option value="MYR">my Malaysian Ringgit (RM)</option>
        </select>
      </div>

      <div class="ci-field">
        <label class="ci-label" for="issueDate">Issue Date <span class="req">*</span></label>
        <input class="ci-input" id="issueDate" type="date">
        <div class="ci-error" id="issueDateErr"></div>
      </div>

      <div class="ci-field">
        <label class="ci-label" for="dueDate">Due Date <span class="req">*</span></label>
        <input class="ci-input" id="dueDate" type="date">
        <div class="ci-quick">
          <button type="button" class="ci-chip" data-days="7">
            <svg viewBox="0 0 24 24" width="16" height="16" class="ic" aria-hidden="true">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>7 days</span>
          </button>
          <button type="button" class="ci-chip" data-days="14">
            <svg viewBox="0 0 24 24" width="16" height="16" class="ic" aria-hidden="true">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>14 days</span>
          </button>
          <button type="button" class="ci-chip" data-days="30">
            <svg viewBox="0 0 24 24" width="16" height="16" class="ic" aria-hidden="true">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>30 days</span>
          </button>
          <button type="button" class="ci-chip" data-days="60">
            <svg viewBox="0 0 24 24" width="16" height="16" class="ic" aria-hidden="true">
              <circle cx="12" cy="12" r="9" fill="none" stroke="currentColor" stroke-width="2"/>
              <path d="M12 7v6l4 2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>60 days</span>
          </button>
        </div>
        <div class="ci-error" id="dueDateErr"></div>
      </div>
    </div>
  </section>

  <!-- Invoice Items -->
  <section class="ci-card">
    <div class="ci-items-head">
      <div>
        <div class="ci-title-sm">Invoice Items</div>
        <div class="ci-muted">Let AI read and auto-fill line items from your document</div>
      </div>

      <button type="button" class="ci-upload" id="uploadBtn">
        <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
          <path d="M12 5v10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 9l4-4 4 4" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M5 19h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>Upload PO / Quote</span>
      </button>
    </div>

    <div class="ci-table">
      <div class="ci-thead">
        <div class="ci-th desc">Description</div>
        <div class="ci-th qty">Quantity</div>
        <div class="ci-th rate">Rate</div>
        <div class="ci-th amt">Amount</div>
      </div>

      <div id="itemsWrap" class="ci-tbody"></div>

      <button type="button" class="ci-addline" id="addItemBtn">＋ Add another line item</button>
      <div class="ci-error" id="itemsErr"></div>
    </div>

    <div class="ci-totals">
      <div class="ci-total-row">
        <div class="ci-total-label">Subtotal</div>
        <div class="ci-total-val" id="subtotalText">S$0.00</div>
      </div>

      <div class="ci-total-row">
        <div class="ci-total-label">
          GST
          <input class="ci-gst" id="gstRate" type="number" min="0" step="0.01" value="9">
          <span class="ci-muted">%</span>
        </div>
        <div class="ci-total-val" id="gstText">S$0.00</div>
      </div>

      <div class="ci-total-row grand">
        <div class="ci-total-label">Total Amount</div>
        <div class="ci-total-val grand" id="totalText">S$0.00</div>
      </div>
    </div>
  </section>

  <!-- Notes -->
  <section class="ci-card">
    <div class="ci-title-sm">Notes (Optional)</div>
    <textarea class="ci-textarea" id="notes" rows="5" placeholder="Add any additional notes or payment terms..."></textarea>
  </section>

  <!-- Bottom actions -->
  <div class="ci-actions">
    <button class="ci-btn" id="saveDraftBtn" type="button">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2Z" fill="none" stroke="currentColor" stroke-width="2"/>
        <path d="M17 21v-8H7v8" fill="none" stroke="currentColor" stroke-width="2"/>
        <path d="M7 3v5h8" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span>Save as Draft</span>
    </button>
    <button class="ci-btn primary" id="previewSubmitBtn" type="button">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
        <path d="M22 12s-4 7-10 7S2 12 2 12s4-7 10-7 10 7 10 7Z" fill="none" stroke="currentColor" stroke-width="2"/>
        <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>
      <span>Preview &amp; Submit</span>
    </button>
    <div class="ci-muted" id="saveMsg"></div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast" hidden></div>

<!-- Select Client: Picker modal -->
<div class="backdrop" id="pickerBackdrop" hidden></div>
<div class="modal lg ci-picker" id="pickerModal" hidden aria-modal="false" role="dialog" aria-labelledby="pickerTitle">
  <div class="ci-picker-head">
    <div>
      <div class="ci-picker-title" id="pickerTitle">Select Client</div>
      <div class="ci-picker-sub">Choose a saved client or create a one-off invoice</div>
    </div>
    <button type="button" class="iconbtn" id="pickerClose" aria-label="Close">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
        <path d="M18 6 6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <div class="ci-picker-body">
    <div class="ci-picker-search">
      <span class="search-ic" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" class="ic">
          <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20l-3.5-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </span>
      <input id="pickerSearch" type="text" placeholder="Search by name, email, or phone..." autocomplete="off">
    </div>

    <button type="button" class="ci-oneoff" id="oneoffStartBtn">
      <div class="ci-oneoff-ic" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" class="ic">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
        </svg>
      </div>
      <div class="ci-oneoff-txt">
        <div class="ci-oneoff-title">One-off Client</div>
        <div class="ci-oneoff-sub">Create invoice without saving client</div>
      </div>
    </button>

    <div class="ci-saved-title" id="savedTitle">Saved Clients (0)</div>
    <div class="ci-saved-list" id="pickerGrid"></div>

    <button type="button" class="ci-picker-cancel" id="pickerCancelBtn">Cancel</button>
  </div>
</div>

<!-- One-off Client modal -->
<div class="backdrop" id="oneoffBackdrop" hidden></div>
<div class="modal sm ci-oneoff-modal" id="oneoffModal" hidden aria-modal="false" role="dialog" aria-labelledby="oneoffTitle">
  <div class="ci-oneoff-head">
    <div class="ci-oneoff-badge" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
      </svg>
    </div>
    <div>
      <div class="ci-oneoff-h1" id="oneoffTitle">One-off Client</div>
      <div class="ci-oneoff-h2">Create invoice without saving client</div>
    </div>
    <button type="button" class="iconbtn" id="oneoffClose" aria-label="Close">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
        <path d="M18 6 6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>
  <div class="ci-oneoff-body">
    <div class="ci-field">
      <label class="ci-label" for="oneoffNameInput">Client Name <span class="req">*</span></label>
      <input class="ci-input" id="oneoffNameInput" type="text" placeholder="Enter client or company name">
      <div class="ci-oneoff-note">This client won't be saved to your database</div>
    </div>
    <div class="ci-oneoff-actions">
      <button type="button" class="ci-oneoff-back" id="oneoffBackBtn">Back</button>
      <button type="button" class="ci-oneoff-continue" id="oneoffContinueBtn">Continue</button>
    </div>
  </div>
</div>

<!-- Select Product: Picker modal (stub) -->
<div class="backdrop" id="prodBackdrop" hidden></div>
<div class="modal lg ci-prod" id="prodModal" hidden aria-modal="false" role="dialog" aria-labelledby="prodTitle">
  <div class="ci-picker-head">
    <div>
      <div class="ci-picker-title" id="prodTitle">Select Product or Service</div>
      <div class="ci-picker-sub">Choose from your catalogue</div>
    </div>
    <button class="iconbtn" id="prodClose" aria-label="Close">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
        <path d="M18 6 6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <div class="ci-prod-body">
    <div class="ci-prod-search">
      <span class="search-ic" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" class="ic">
          <circle cx="11" cy="11" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20l-3.5-3.5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </span>
      <input id="prodSearch" type="text" placeholder="Search by name, SKU, or description..." autocomplete="off">
    </div>

    <div class="ci-prod-filters" role="tablist" aria-label="Product filters">
      <button type="button" class="ci-pill active" data-cat="All">All</button>
      <button type="button" class="ci-pill" data-cat="Products">Products</button>
      <button type="button" class="ci-pill" data-cat="Services">Services</button>
      <button type="button" class="ci-pill" data-cat="Packages">Packages</button>
      <button type="button" class="ci-pill" data-cat="Consulting">Consulting</button>
    </div>

    <div class="ci-saved-title" id="prodListTitle">Select from Catalogue (0)</div>
    <div class="ci-prod-list" id="prodList"></div>

    <button type="button" type="button" class="ci-picker-cancel" id="prodCancelBtn" onclick="closeClientModal()">Cancel</button>
  </div>
</div>
<!-- AI Smart Data Capture (Upload PO / Quote) -->
<input type="file" id="poFileInput" accept=".pdf,.txt,.png,.jpg,.jpeg" hidden>

<div class="backdrop" id="aiBackdrop" hidden></div>
<div class="modal xl ci-ai" id="aiModal" hidden aria-modal="false" role="dialog" aria-labelledby="aiTitle">
  <div class="ci-ai-head">
    <div class="ci-ai-badge" aria-hidden="true">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic">
        <path d="M12 2l1.4 4.2L18 8l-4.6 1.8L12 14l-1.4-4.2L6 8l4.6-1.8L12 2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
        <path d="M5 14l.9 2.6L9 18l-3.1 1.4L5 22l-.9-2.6L1 18l3.1-1.4L5 14Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
      </svg>
    </div>
    <div>
      <div class="ci-ai-title" id="aiTitle">AI Smart Data Capture</div>
      <div class="ci-ai-sub">Review extracted items</div>
    </div>
    <button class="iconbtn" id="aiClose" aria-label="Close">
      <svg viewBox="0 0 24 24" width="18" height="18" class="ic" aria-hidden="true">
        <path d="M18 6 6 18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
  </div>

  <div class="ci-ai-body">
    <div class="ci-ai-grid">
      <div class="ci-ai-left">
        <div class="ci-ai-coltitle">Uploaded Document</div>
        <div class="ci-ai-doccard" id="aiDocCard">
          <div class="ci-ai-docicon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="26" height="26" class="ic">
              <path d="M4 21V3h10l6 6v12H4Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M14 3v6h6" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M7.5 13h9" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7.5 16.5h7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="ci-ai-docname" id="aiDocName">No file selected</div>
          <div class="ci-ai-docmeta" id="aiDocMeta">—</div>
        </div>
      </div>

      <div class="ci-ai-right">
        <div class="ci-ai-righthead">
          <div class="ci-ai-coltitle" id="aiDetectedTitle">Detected Items (0/0 selected)</div>
          <div class="ci-ai-actions">
            <button type="button" class="ci-ai-link" id="aiSelectAllBtn">Select All</button>
            <button type="button" class="ci-ai-link" id="aiClearBtn">Clear</button>
          </div>
        </div>

        <div class="ci-ai-list" id="aiList"></div>
      </div>
    </div>

    <div class="ci-ai-footer">
      <div class="ci-ai-total">
        <div class="k">Total: <span class="v" id="aiTotalText">S$0.00</span></div>
        <div class="m" id="aiSelectedCount">0 items selected</div>
      </div>
      <div class="ci-ai-footbtns">
        <button type="button" type="button" class="ci-btn ghost" id="aiCancelBtn" onclick="closeClientModal()">Cancel</button>
        <button type="button" class="ci-btn gold" id="aiAddBtn">
          <span class="icwrap" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" class="ic">
              <path d="M12 2l1.4 4.2L18 8l-4.6 1.8L12 14l-1.4-4.2L6 8l4.6-1.8L12 2Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </span>
          <span>Add Selected Items</span>
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/invoice.js') }}"></script>
{% endblock %}