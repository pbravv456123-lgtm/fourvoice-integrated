<!-- 
DELIVERY
READ (filter by status/search)
READ (get single invoice details)
UPDATE (resend invoice to client)

APPROVALS
READ (display approvals dashboard)
UPDATE (approve/reject/hold invoices)

EDIT INVOICE
UPDATE (save edited invoice + line items) -->

{% extends "base.html" %}
{% block content %}

<div class="fv-main">

  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="fw-bold mb-1">Invoice Delivery</h1>
      <p class="text-muted">Track and monitor invoice delivery status</p>
    </div>

    <button class="btn btn-primary fv-top-btn">
      <i class="bi bi-send"></i>
      Send Invoice
    </button>
  </div>

  <!-- STATUS CARDS -->
  <div class="row g-3 mb-4">
    {% for key,label,value in [
      ('all','Total Sent',counts.total),
      ('delivered','Delivered',counts.delivered),
      ('opened','Opened',counts.opened),
      ('pending','Pending',counts.pending),
      ('failed','Failed',counts.failed)
    ] %}
    <div class="col">
      <div class="card fv-stat-card {% if active_status==key %}active{% endif %}"
          data-status="{{ key }}">
        <div class="fw-semibold">{{ label }}</div>
        <div class="fs-3 fw-bold">{{ value or 0 }}</div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- SEARCH -->
  <div class="card p-3 mb-3">
    <div class="fv-search">
      <i class="bi bi-search"></i>
      <input
        class="form-control fv-search-input"
        id="searchInput"
        placeholder="Search by invoice number, client, or email..."
        value="{{ query }}"
      >
    </div>
  </div>


  
  <!-- DATE FILTER -->
  <div class="card p-3 mb-3">
    <div class="fw-semibold text-muted mb-3">Filter by Date</div>
    <div class="row g-2">
      <div class="col-md-6">
        <label class="form-label small">From Date</label>
        <input type="text" class="form-control" id="dateFrom" placeholder="dd/mm/yyyy" maxlength="10">
      </div>
      <div class="col-md-6">
        <label class="form-label small">To Date</label>
        <input type="text" class="form-control" id="dateTo" placeholder="dd/mm/yyyy" maxlength="10">
      </div>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="d-flex align-items-center justify-content-between">
      <div class="fw-semibold text-muted">Filter by Status</div>

      <div class="d-flex gap-2">
        {% for key,label in [
          ('all','All'),
          ('delivered','Delivered'),
          ('opened','Opened'),
          ('pending','Pending'),
          ('failed','Failed')
        ] %}
        <button class="fv-pill {% if active_status==key %}active{% endif %}"
                data-status="{{ key }}">
          {{ label }}
          <span class="pill-count">
            {%- if key == 'all' -%}
              ({{ counts.total or 0 }})
            {%- else -%}
              ({{ counts[key] or 0 }})
            {%- endif -%}
          </span>
        </button>
        {% endfor %}
      </div>
    </div>
  </div>


  <!-- TABLE -->
<div class="card">
  <table class="table mb-0 fv-table">
    <thead>
      <tr>
        <th>Invoice #</th>
        <th>Client</th>
        <th>Email</th>
        <th>Sent Date</th>
        <th>Opened Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% if invoices %}
        {% for i in invoices %}
        <tr class="fv-row" data-invoice-id="{{ i.id }}">
          <td class="text-primary fw-semibold">{{ i.invoice_number }}</td>
          <td>{{ i.client_name }}</td>
          <td>{{ i.email }}</td>
          <td>{% set sent_date_only = i.sent_date.split(' ')[0] if ' ' in i.sent_date else i.sent_date %}{% set sent_parts = sent_date_only.split('-') %}{{ sent_parts[2] }}/{{ sent_parts[1] }}/{{ sent_parts[0] }}</td>
          <td>{% if i.opened_date %}{% set opened_date_only = i.opened_date.split(' ')[0] if ' ' in i.opened_date else i.opened_date %}{% set opened_parts = opened_date_only.split('-') %}{{ opened_parts[2] }}/{{ opened_parts[1] }}/{{ opened_parts[0] }}{% else %}-{% endif %}</td>
          <td>
            {% set display_status = i.effective_status if i.effective_status else i.status %}
            <span class="fv-status {{ display_status }}">
              {{ display_status|capitalize }}
            </span>
          </td>
          <td>
            <!-- Resend pill button with data attribute -->
            <button class="btn-resend-pill" data-invoice-id="{{ i.id }}" title="Resend invoice">
              Resend
            </button>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr id="no-invoices-row">
          <td colspan="7" class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <div class="mt-3">No invoices found</div>
          </td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

  




<!-- INVOICE DETAIL MODAL -->
<div class="fv-modal-overlay" id="invoiceModal">
  <div class="fv-modal">
    <div class="fv-modal-header">
      <div>
        <h5 class="mb-0 fw-bold" id="modalInvoiceNumber">INV-</h5>
        <small class="text-muted" id="modalClientEmail"></small>
      </div>
      <button class="fv-modal-close" onclick="closeInvoiceModal()">×</button>
    </div>

    <div class="fv-modal-body">
      <!-- TOP SECTION - DELIVERY INFO -->
      <div class="fv-delivery-card mb-4">
        <div class="fv-delivery-grid">
          <!-- Delivery Status -->
          <div class="fv-delivery-item">
            <div class="fv-label">Delivery Status</div>
            <span class="fv-status" id="modalStatus"></span>
          </div>
          
          <!-- Sent To -->
          <div class="fv-delivery-item">
            <div class="fv-label">Sent To</div>
            <div id="modalEmail" class="fv-email"></div>
          </div>
          
          <!-- Opened Date/Time -->
          <div class="fv-delivery-item">
            <div class="fv-label">Opened Date/Time</div>
            <div id="modalOpenedDateTime" class="text-muted">-</div>
          </div>
        </div>
        
      </div>

      <!-- INVOICE DETAILS - Updated to use correct classes -->
      <div class="invoice-details-row mb-4">
        <div class="invoice-details-item">
          <div class="fv-label">Issue Date</div>
          <div id="modalIssueDate" class="fw-medium">-</div>
        </div>
        <div class="invoice-details-item">
          <div class="fv-label">Due Date</div>
          <div id="modalDueDate" class="fw-medium">-</div>
        </div>
        <div class="invoice-details-item">
          <div class="fv-label">Total Amount</div>
          <div id="modalAmount" class="fv-amount">$0.00</div>
        </div>
      </div>

      <!-- CLIENT INFORMATION -->
      <h6 class="fw-bold mb-3">Client Information</h6>
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-6">
              <div class="fv-label">Client Name</div>
              <div id="modalClientName" class="fw-medium">-</div>
            </div>
            <div class="col-6">
              <div class="fv-label">Business Location</div>
              <div id="modalBusinessLocation" class="text-muted">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- INVOICE ITEMS TABLE -->
      <h6 class="fw-bold mb-3">Invoice Items</h6>
      <table class="table fv-modal-table mb-4">
        <thead>
          <tr>
            <th>Description</th>
            <th class="text-center">Qty</th>
            <th class="text-end">Rate</th>
            <th class="text-end">Amount</th>
          </tr>
        </thead>
        <tbody id="modalItems">
          <!-- Items will be inserted here by JavaScript -->
        </tbody>
        <tfoot id="modalTotals">
          <!-- Totals will be inserted here by JavaScript -->
        </tfoot>
      </table>

      <!-- WEBHOOK STATUS NOTICE -->
      <div class="alert alert-warning d-flex align-items-start" id="webhookDisabledNotice" style="display: none !important;">
        <i class="bi bi-exclamation-triangle-fill me-3 flex-shrink-0" style="font-size: 1.5rem;"></i>
        <div>
          <h6 class="alert-heading mb-2 fw-bold" id="webhookNoticeTitle">Manual Tracking Required</h6>
          <p class="mb-2 small" id="webhookNoticeMessage">
            Delivery tracking is not fully available. You must manually verify delivery status from your 
            <a href="https://dashboard.serversmtp.com/dashboard" target="_blank" class="alert-link">TurboSMTP Dashboard</a>.
          </p>
          <p class="mb-0 small text-muted" id="webhookNoticeHint">
            <i class="bi bi-info-circle"></i> Only <strong>opened invoices</strong> (link clicks) are tracked automatically.
          </p>
        </div>
      </div>

      <!-- MANUAL ADMIN ACTIONS (shown when webhook disabled) -->
      <div class="card border-primary mb-4" id="manualActionsCard" style="display: none;">
        <div class="card-body">
          <h6 class="card-title fw-bold mb-3">
            <i class="bi bi-hand-index"></i> Manual Status Actions
          </h6>
          <p class="text-muted small mb-3">
            After verifying delivery status in TurboSMTP Dashboard:
          </p>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-success" id="modalMarkDeliveredBtn2">
              <i class="bi bi-check-circle"></i> Mark as Delivered
            </button>
            <button class="btn btn-outline-warning" id="modalMarkPendingBtn2">
              <i class="bi bi-clock-history"></i> Mark as Pending
            </button>
            <button class="btn btn-outline-danger" id="modalMarkFailedBtn2">
              <i class="bi bi-x-circle"></i> Mark as Failed
            </button>
          </div>
          <small class="text-muted d-block mt-2">
            <i class="bi bi-info-circle"></i> These actions update the invoice status based on TurboSMTP delivery reports.
          </small>
        </div>
      </div>

    </div>

    <div class="fv-modal-footer">
      <button class="btn btn-outline-secondary" onclick="closeInvoiceModal()">
        <i class="bi bi-x-lg"></i> Close
      </button>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary fv-modal-action-btn" id="modalPreviewBtn">
          <i class="bi bi-eye"></i> Preview PDF
        </button>
        <button class="btn btn-primary fv-modal-action-btn" id="modalResendBtn">
          <i class="bi bi-send"></i> Resend Invoice
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Resend Confirmation Modal -->
<div class="fv-modal-overlay" id="resendConfirmModal" style="display: none;">
  <div class="fv-modal" style="max-width: 500px;">
    <div class="fv-modal-header">
      <div>
        <h5 class="mb-0 fw-bold">Confirm Resend</h5>
      </div>
      <button class="fv-modal-close" onclick="closeResendConfirm()">×</button>
    </div>

    <div class="fv-modal-body">
      <p id="resendConfirmMessage" class="mb-0">
        <i class="bi bi-exclamation-circle text-warning me-2"></i>
        Are you sure you want to resend this invoice?
      </p>
    </div>

    <div class="fv-modal-footer">
      <button class="btn btn-outline-secondary" onclick="closeResendConfirm()">
        Cancel
      </button>
      <button class="btn btn-primary" id="resendConfirmBtn">
        <i class="bi bi-send"></i> Confirm Resend
      </button>
    </div>
  </div>
</div>

</div>

<link rel="stylesheet"
 href="{{ url_for('static', filename='css/invoice_delivery/invoice_delivery.css') }}">
<script>
  window.currentUserRole = "{{ current_user_role }}";
</script>
<script src="{{ url_for('static', filename='css/invoice_delivery/invoice_delivery.js') }}"></script>

{% endblock %}